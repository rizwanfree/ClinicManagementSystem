{% extends "base.html" %}


{% block content %}
<div class="row">
    <!-- Patients -->
    <div class="col-md-3">
        <div class="card mb-3 shadow bg-primary text-white">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">Total Patients</h5>
                    <p class="card-text display-6 fw-bold mb-0">{{ patients_count }}</p>
                </div>
                <i class="bi bi-people display-4 opacity-50"></i>
            </div>
        </div>
    </div>

    <!-- Appointments Today -->
    <div class="col-md-3">
        <div class="card mb-3 shadow bg-success text-white">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">Appointments Today</h5>
                    <p class="card-text display-6 fw-bold mb-0">{{ appointments_count_today }}</p>
                </div>
                <i class="bi bi-calendar-check display-4 opacity-50"></i>
            </div>
        </div>
    </div>

    <!-- Total Appointments -->
    <div class="col-md-3">
        <div class="card mb-3 shadow bg-warning text-dark">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">Total Appointments</h5>
                    <p class="card-text display-6 fw-bold mb-0">{{ appointments_count_total }}</p>
                </div>
                <i class="bi bi-bar-chart-line display-4 opacity-50 text-dark"></i>
            </div>
        </div>
    </div>

    <!-- Extra Info -->
    <div class="col-md-3">
        <div class="card mb-3 shadow bg-info text-white">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">Extra Info</h5>
                    <p class="card-text display-6 fw-bold mb-0">0</p>
                </div>
                <i class="bi bi-info-circle display-4 opacity-50"></i>
            </div>
        </div>
    </div>
</div>


 {% comment %} Datatables {% endcomment %}
<div class="col-md-12">
    <div class="card mt-0 shadow">
        <div class="card-body">
            
            

            <!-- Navigation buttons -->
            <div class="d-flex justify-content-between mb-3">
                <a href="?date={{ prev_date|date:"Y-m-d" }}">← Previous</a>
                <h4 class="card-title text-center">Appointments – {{ selected_date }}</h4>
                <a href="?date={{ next_date|date:"Y-m-d" }}">Next →</a>
            </div>

            <!-- New Appointment Button -->
            {% comment %} <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">
                + New Appointment
            </button> {% endcomment %}

            <!-- DataTable -->
            <table id="appointmentsTable" class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th class="text-center">Token #</th>
                        <th class="text-center">MR #</th>
                        <th class="text-center">Patient</th>
                        <th class="text-center">Doctor</th>                        
                        <th class="text-center">Paid</th>
                        <th class="text-center">Status</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in appointments %}
                    <tr>
                        <td class="text-center align-middle">{{ a.token_number }}</td>
                        <td class="text-center align-middle">{{ a.patient.mr_number }}</td>
                        <td class="text-center align-middle">{{ a.patient.first_name }} {{ a.patient.last_name }}</td>
                        <td class="text-center align-middle">{{ a.doctor.first_name }} {{ a.doctor.last_name }}</td>
                        
                        <!-- Payment Info -->
                        <td class="text-center align-middle">
                            {% if a.bill %}
                                {{ a.bill.status }}
                                <br>
                                <small class="text-muted">{{ a.bill.paid_amount }} / {{ a.bill.total_amount }}</small>
                            {% else %}
                                <span class="badge bg-warning">No Bill</span>
                            {% endif %}
                        </td>

                        <td class="text-center align-middle">{{ a.status }}</td>

                        <td class="text-end align-middle">
                            {% if a.bill %}
                                <a class="btn btn-sm btn-secondary" href="#">View Bill</a>
                            {% else %}
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#newInvoiceModal"
                                    data-appointment-id="{{ a.id }}"
                                    data-patient-name="{{ a.patient.first_name }} {{ a.patient.last_name }}"
                                    data-patient-mr="{{ a.patient.mr_number }}">
                                Add Invoice
                            </button>
                            {% endif %}
                            <a class="btn btn-sm btn-info" href="{% url 'patient_detail' a.patient.id %}">Details →</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>



<!-- New Appointment Modal -->
{% include "partials/appointment_modal.html" %}
{% include "partials/invoice_modal.html" %}



<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    var table = $('#appointmentsTable').DataTable({
        dom: '<"d-flex justify-content-between mb-3"<"dt-buttons">f>rtip', 
        // f = filter (search box), dt-buttons = custom buttons container
    });

    // Add New Appointment button after search input
    $("div.dt-buttons").html(`
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">
            <i class="bi bi-plus-circle"></i> New Appointment
        </button>
    `);
});
</script>
{% endblock %}
